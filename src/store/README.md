
# ストア
アプリ全体のデータを管理する  
ストアの管理するデータは `$state` なオブジェクトとして公開される  
公開された `$state` なオブジェクトは基本的に**不変なオブジェクト**として扱われる必要がある

ストア内では `$state` な状態を更新する時に最小単位で（プリミティブ値まで探索して）更新する必要がある  
これを安全に行うのが `safeOverwrite**` 関数

`$state` が不変なオブジェクトとして扱われるべき理由は、この状態を変更しても外部ストアは更新されない（更新してはダメ）なため  
（`$state` を直接 `$effect` で囲んで外部ストアを更新するようなことはダメ）  
しかしストア（アプリの状態）と外部ストアは同じ状態を保つ必要がある  
そのために状態を更新する（更新を通知する）関数を公開し、その関数からのみ外部ストアを更新する

しかしビューでは値をバインドしてビューの変更から直接外部ストアを更新したい  
そのために `notifierStore` 関数を使ってこれを実現する （使用例 [Setting.svelte](../view/Setting.svelte)）  
また `notifierStore` を使うことでビューの状態とストアの状態を独立して扱う事が出来る  
（状態を更新するためのビューと、外部ストアを更新するためのストアインターフェースは、お互いに依存しない状態を保つ）

外部ストアとの連携は `connectExtenralStore` 関数を使う  
外部ストアの更新と外部ストアの変更を受け取る事が出来る

以下はユーザーストア（`userStore`）とニコ生クライアント（`Nicolive`）の例
> `userStore.users[ID]` と `Nicolive.users[ID].storeUser` はIDが同じなら参照しているオブジェクトは同じである  
> `userStore.users` は外部ストアにより更新されたら `safeOverwriteUser` 関数で更新し `userStore.updated` を呼び出す  
> `userStore.updated` 経由で `Nicolive.users[ID].storeUser` の作成・削除を行う  
> ただ更新されただけの場合は、すでに同じ参照を持っているため何もしない


## メモ
* 現在のコードでは拡張機能ストレージでアイテムが `null` な場合に
  * ロード時に無視される
  * onChange 時に削除されたアイテムとして扱われる
